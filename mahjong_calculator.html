<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»å°‡å°è²»èˆ‡è¼¸è´è¨ˆç®—æ©Ÿ</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šç¾©å­—é«”å’Œé¡è‰²ï¼Œæå‡è³ªæ„Ÿ */
        body {
            font-family: 'Inter', sans-serif;
            /* æ·±è‰²èƒŒæ™¯ */
            background-color: #0f172a; /* Slate-900 */
        }
        .container {
            max-width: 900px;
        }
        .card {
            border-radius: 1rem;
            /* æ›´æ·±çš„é™°å½± */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05); /* è¼•å¾®é‚Šæ¡† */
        }
        .input-field {
            border-radius: 0.5rem;
            border: 2px solid #334155; /* Slate-700 */
            padding: 0.75rem;
            width: 100%;
            transition: border-color 0.2s, background-color 0.2s;
            background-color: #1e293b; /* Slate-800 */
            color: #f8fafc; /* Light text */
        }
        .input-field:focus {
            border-color: #f59e0b; /* Amber/Gold accent */
            outline: none;
            background-color: #1e293b;
        }
        /* è®“è¤‡è£½å€å¡Šçœ‹èµ·ä¾†æ›´åƒä»£ç¢¼è¼¸å‡º */
        #copyTextOutput {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            background-color: #1e293b;
            color: #d1d5db;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="container mx-auto">
        <!-- æ›´æ–°ä¸»æ¨™é¡Œ -->
        <h1 class="text-3xl font-bold text-center text-amber-400 mb-8">ğŸ€„ éº»å°‡å¸³å‹™è¨ˆç®—å™¨ | Mahjong Counting Machine ğŸ’°</h1>
        
        <!-- è¦å‰‡èªªæ˜å¡ç‰‡ - å·²ç¾åŒ– -->
        <div class="card bg-gray-900 p-6 mb-6 border border-blue-700/30">
            <h2 class="text-xl font-extrabold text-blue-300 mb-4 border-b border-blue-800 pb-2">ğŸ“‹ è¨ˆåˆ†è¦å‰‡ç¢ºèª (5/5 æ’²å…‹ç‰Œé»æ•¸åˆ¶)</h2>
            <ul class="space-y-3">
                <!-- é …ç›®åˆ—è¡¨ç¾åŒ–ï¼Œä½¿ç”¨ Flex ä½ˆå±€å’Œåœ–æ¨™ -->
                <li class="flex items-start text-gray-300">
                    <span class="text-blue-400 mr-3 mt-1">â˜…</span>
                    <div>
                        <strong class="text-amber-300">åº•æ³¨ï¼š</strong> 1 é» = 5 å…ƒã€‚
                    </div>
                </li>
                <li class="flex items-start text-gray-300">
                    <span class="text-blue-400 mr-3 mt-1">â˜…</span>
                    <div>
                        <strong class="text-amber-300">æ»¿é»ï¼š</strong> æ¯äººèµ·å§‹é»æ•¸ç‚º 100 é» (A-10=1~10é», JQK=15é», å…± 13 å¼µç‰Œ)ã€‚
                    </div>
                </li>
                <li class="flex items-start text-gray-300">
                    <span class="text-blue-400 mr-3 mt-1">â˜…</span>
                    <div>
                        <strong class="text-amber-300">è¼¸è´è¨ˆç®—ï¼š</strong> çµç®—é»æ•¸å·®é¡ * 5 å…ƒã€‚
                    </div>
                </li>
                <li class="flex items-start text-gray-300">
                    <span class="text-blue-400 mr-3 mt-1">â˜…</span>
                    <div>
                        <strong class="text-amber-300">å°è²»åˆ†æ”¤ï¼š</strong> ç¸½å°è²»å¹³å‡åˆ†çµ¦ 4 äººã€‚
                    </div>
                </li>
            </ul>
        </div>

        <!-- ç¸½å°è²»è¼¸å…¥å¡ç‰‡ (åŸ 1.) -->
        <div class="card bg-gray-800 p-6 mb-6">
            <h2 class="text-xl font-semibold text-amber-400 mb-4">ğŸ’¸ ç¸½å°è²»é‡‘é¡</h2>
            <label for="totalFee" class="block text-sm font-medium text-gray-300 mb-2">è«‹è¼¸å…¥ç¸½å°è²» (å…ƒ)</label>
            <input type="number" id="totalFee" value="200" min="0" class="input-field text-lg" oninput="calculateSettlement()">
        </div>
        
        <!-- ç©å®¶çµé¤˜é»æ•¸è¼¸å…¥å¡ç‰‡ (åŸ 2.) -->
        <div class="card bg-gray-800 p-6 mb-6">
            <h2 class="text-xl font-semibold text-amber-400 mb-4">ğŸƒ ç©å®¶çµé¤˜é»æ•¸ (èµ·å§‹ 100 é»)</h2>
            <div id="playerInputs" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- è¼¸å…¥æ¬„ä½æœƒç”± JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å°è²»å¢Šä»˜äººå¡ç‰‡ (åŸ 3.) -->
        <div class="card bg-gray-800 p-6 mb-8">
            <h2 class="text-xl font-semibold text-amber-400 mb-4">ğŸ›¡ï¸ å°è²»å¢Šä»˜äºº</h2>
            <!-- ä¿®æ­£ï¼šæ”¹ç”¨ grid grid-cols-4 å¯¦ç¾å¹³å‡åˆ†ä½ˆæ¬„å¯¬ -->
            <div id="feePayer" class="grid grid-cols-4 gap-3">
                <!-- ä»˜è²»äººé¸é …æœƒç”± JS ç”Ÿæˆ -->
            </div>
        </div>
        
        <!-- çµç®—çµæœå¡ç‰‡ (åŸ 4.) -->
        <div class="card bg-green-900/30 p-6 border-2 border-green-700/50">
            <h2 class="text-2xl font-bold text-green-400 mb-4">ğŸ’µ æœ€çµ‚å¸³å‹™çµæœ (å³æ™‚æ›´æ–°)</h2>
            
            <div id="resultsSummary" class="text-lg mb-2 space-y-3">
                <!-- çµæœæ‘˜è¦æœƒç”± JS é¡¯ç¤º -->
                <p class="text-gray-400">è«‹è¼¸å…¥é»æ•¸å’Œå°è²»è³‡è¨Šï¼Œçµæœå°‡è‡ªå‹•æ›´æ–°ã€‚</p>
            </div>
        </div>

        <!-- è¤‡è£½è¨Šæ¯æ¡† -->
        <div class="mt-8">
            <!-- ç§»é™¤ä¸å¿…è¦çš„æè¿°æ–‡å­— -->
            <h3 class="text-xl font-semibold text-gray-200 mb-3">âœ… ç¾¤çµ„è½‰å¸³è¨Šæ¯</h3> <!-- æ¨™é¡Œå·²ä¿®æ”¹ -->
            <textarea id="copyTextOutput" rows="8" readonly class="w-full p-4 border border-gray-700 rounded-lg text-sm focus:outline-none"></textarea>
            <!-- æ›´æ”¹æŒ‰éˆ•æ–‡å­— -->
            <button onclick="copyToClipboard()" class="w-full mt-2 bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-3 rounded-lg transition duration-200 shadow-lg">
                è¤‡è£½è¨Šæ¯ <!-- æŒ‰éˆ•æ–‡å­—å·²ä¿®æ”¹ -->
            </button>
        </div>
        
        <!-- è¨Šæ¯é€šçŸ¥å®¹å™¨ -->
        <div id="notification"></div>
        
    </div>

    <script>
        // ç©å®¶æ¸…å–®
        const PLAYERS = ['å§œ', 'æ­', 'æ', 'é»ƒ'];
        const POINT_VALUE = 5; // 1 é» = 5 å…ƒ
        const STARTING_POINTS = 100; // æ¯äººæ»¿é»

        // åˆå§‹åŒ–è¼¸å…¥æ¬„ä½å’Œä»˜è²»äººé¸é …
        document.addEventListener('DOMContentLoaded', () => {
            const playerInputsDiv = document.getElementById('playerInputs');
            const feePayerDiv = document.getElementById('feePayer');
            
            PLAYERS.forEach((name, index) => {
                // é»æ•¸è¼¸å…¥æ¬„ä½
                playerInputsDiv.innerHTML += `
                    <div>
                        <!-- å¢å¼·ç©å®¶åå­—çš„é¡¯ç¤ºæ•ˆæœ -->
                        <label for="points_${name}" class="block text-sm font-medium text-gray-300 mb-2">
                            <span class="text-lg font-extrabold text-amber-300">${name}</span> çµé¤˜é»æ•¸
                        </label>
                        <!-- ä¿®æ­£ï¼šç§»é™¤ max é™åˆ¶ï¼Œå› ç‚ºè´éŒ¢æœƒè¶…é 100 é» -->
                        <input type="number" id="points_${name}" value="${STARTING_POINTS}" min="0" class="input-field text-xl text-center" oninput="calculateSettlement()">
                    </div>
                `;

                // å°è²»ä»˜è²»äººé¸é … - ä½¿ç”¨ç£šå½¢æŒ‰éˆ•æ¨£å¼
                feePayerDiv.innerHTML += `
                    <div class="relative">
                        <input 
                            id="payer_${name}" 
                            name="payer" 
                            type="radio" 
                            value="${name}" 
                            class="hidden peer" 
                            ${index === 0 ? 'checked' : ''} 
                            onchange="calculateSettlement()"
                        >
                        <label for="payer_${name}" class="
                            block py-2 px-6 rounded-lg cursor-pointer text-base font-semibold
                            transition-all duration-200 select-none text-center w-full /* ç¢ºä¿å¡«æ»¿ grid cell */
                            bg-gray-700 text-gray-400 border border-gray-600 
                            peer-checked:bg-amber-500 peer-checked:text-gray-900 peer-checked:border-amber-500
                            hover:bg-gray-600 hover:text-gray-200
                        ">
                            ${name}
                        </label>
                    </div>
                `;
            });
            
            // é¦–æ¬¡è¼‰å…¥æ™‚åŸ·è¡Œè¨ˆç®—
            calculateSettlement();
        });

        function calculateSettlement() {
            const totalFee = parseFloat(document.getElementById('totalFee').value) || 0;
            const feeShare = totalFee / 4;
            // ç¢ºä¿æœ‰é¸ä¸­ä»˜è²»äººï¼Œå¦å‰‡é»˜èªç¬¬ä¸€å€‹
            const payerRadio = document.querySelector('input[name="payer"]:checked');
            const payerName = payerRadio ? payerRadio.value : PLAYERS[0];
            
            const results = [];
            let totalRemainingPoints = 0;
            
            // 1. è¨ˆç®—éŠæˆ²è¼¸è´é»æ•¸å’Œé‡‘é¡
            PLAYERS.forEach(name => {
                const inputElement = document.getElementById(`points_${name}`);
                const remainingPoints = parseInt(inputElement ? inputElement.value : STARTING_POINTS) || 0;
                totalRemainingPoints += remainingPoints;

                const pointsNet = remainingPoints - STARTING_POINTS;
                const gameSettlement = pointsNet * POINT_VALUE; // éŠæˆ²çµç®—é‡‘é¡

                results.push({
                    name,
                    pointsNet,
                    gameSettlement,
                    isPayer: name === payerName,
                    finalSettlement: 0, // æœ€çµ‚çµç®—é‡‘é¡
                    status: ''
                });
            });


            // 2. è¨ˆç®—æœ€çµ‚çµç®—é‡‘é¡ (éŠæˆ²è¼¸è´ + å°è²»åˆ†æ”¤)
            results.forEach(player => {
                let feeAdjustment = 0;
                
                if (player.isPayer) {
                    // å¢Šä»˜äººï¼šæ‡‰å¾—å›çš„é‡‘é¡ = ç¸½å°è²» - è‡ªå·±çš„ä»½é¡
                    feeAdjustment = totalFee - feeShare;
                } else {
                    // éå¢Šä»˜äººï¼šéœ€æ”¯ä»˜è‡ªå·±çš„å°è²»ä»½é¡
                    feeAdjustment = -feeShare;
                }
                
                // ç‚ºäº†é¿å…æµ®é»æ•¸å•é¡Œï¼Œå››æ¨äº”å…¥åˆ°æ•´æ•¸
                player.finalSettlement = Math.round(player.gameSettlement + feeAdjustment);
                player.status = player.finalSettlement >= 0 ? 'è´å®¶ (æ”¶æ¬¾)' : 'è¼¸å®¶ (ä»˜æ¬¾)';
            });
            
            // 3. é¡¯ç¤ºçµæœæ‘˜è¦ (åŒ…å«é»æ•¸å®ˆæ†é©—è­‰)
            displayResults(results, totalFee, feeShare);

            // 4. ç”Ÿæˆè½‰å¸³æŒ‡ä»¤ (é‚„åŸç°¡æ½”ç‰ˆæœ¬)
            generateCopyText(results, payerName, totalFee);
        }

        function displayResults(results, totalFee, feeShare) {
            const summaryDiv = document.getElementById('resultsSummary');
            
            // æª¢æŸ¥é»æ•¸æ˜¯å¦å®ˆæ† (å¿…é ˆç‚º 400 é»)
            const totalPointsInput = results.reduce((sum, p) => sum + (parseInt(document.getElementById(`points_${p.name}`).value) || 0), 0);
            const expectedTotalPoints = STARTING_POINTS * 4;
            
            let deviationText = '';
            if (totalPointsInput !== expectedTotalPoints) {
                // å¦‚æœé»æ•¸ä¸ç­‰æ–¼ 400 é»ï¼Œé¡¯ç¤ºè­¦å‘Š
                deviationText = `<p class="text-sm text-red-400 font-medium bg-red-900/50 p-2 rounded-lg">
                                  âš ï¸ **é»æ•¸é©—è­‰å¤±æ•—**ï¼šç¸½çµé¤˜é»æ•¸ç‚º ${totalPointsInput}ï¼Œèˆ‡æ‡‰æœ‰ç¸½å’Œ 400 ä¸ç¬¦ï¼è«‹æª¢æŸ¥è¼¸å…¥ã€‚
                                </p>`;
            }


            summaryDiv.innerHTML = `
                <p class="text-lg text-gray-300 font-medium">ç¸½å°è²»ï¼š${totalFee.toFixed(0)} å…ƒï¼Œæ¯äººæ‡‰åˆ†æ”¤ï¼š${feeShare.toFixed(0)} å…ƒ</p>
                <hr class="my-3 border-green-700/50">
                ${deviationText}
            `;
            
            results.forEach(p => {
                const finalAmount = Math.abs(p.finalSettlement);
                const colorClass = p.finalSettlement >= 0 ? 'text-amber-400 font-bold' : 'text-red-400 font-bold';
                const action = p.finalSettlement >= 0 ? 'æ‡‰æ”¶' : 'æ‡‰ä»˜';
                const sign = p.finalSettlement >= 0 ? '+' : '-';
                
                // éŠæˆ²çµç®—é‡‘é¡å’Œå°è²»åˆ†æ”¤çš„é¡¯ç¤º
                const feeSign = p.isPayer ? '+' : '-';
                const feeDisplay = p.isPayer ? `${(totalFee - feeShare).toFixed(0)} (æ”¶å›å¢Šä»˜)` : `${feeShare.toFixed(0)} (ä»˜å°è²»)`;
                
                summaryDiv.innerHTML += `
                    <p class="flex justify-between items-center text-gray-300">
                        <span class="font-semibold">${p.name} (${p.isPayer ? 'å·²å¢Šä»˜' : 'æœªå¢Šä»˜'}):</span>
                        <span class="${colorClass}">
                            ${action} ${finalAmount.toFixed(0)} å…ƒ
                            <span class="text-xs text-gray-500 ml-2">(${sign}${Math.abs(p.gameSettlement).toFixed(0)} éŠæˆ² ${feeSign} ${feeDisplay})</span>
                        </span>
                    </p>
                `;
            });
        }

        function generateCopyText(results, payerName, totalFee) {
            
            // æ•´ç†éœ€è¦ä»˜æ¬¾å’Œæ”¶æ¬¾çš„äºº
            const debtors = results.filter(p => p.finalSettlement < 0).sort((a, b) => a.finalSettlement - b.finalSettlement);
            const creditors = results.filter(p => p.finalSettlement > 0).sort((a, b) => b.finalSettlement - a.finalSettlement);

            // --- é‚„åŸç‚ºç°¡æ½”çš„ç´”æ–‡æœ¬æ ¼å¼ ---
            let copyText = `
--- ğŸ’° ç‰Œå±€å¸³å‹™å ±å‘Š ---

ğŸ“… æ—¥æœŸ: ${new Date().toLocaleDateString('zh-Hant')}
ğŸ’° ç¸½å°è²»: ${totalFee.toFixed(0)} å…ƒ (æ¯äººåˆ†æ”¤: ${(totalFee/4).toFixed(0)} å…ƒ)
âœ… å°è²»å¢Šä»˜äºº: ${payerName}

--- å€‹äººæœ€çµ‚æ‡‰æ”¶/ä»˜ ---
`;

            results.forEach(p => {
                const amount = Math.abs(p.finalSettlement).toFixed(0);
                const action = p.finalSettlement >= 0 ? 'æ‡‰æ”¶' : 'æ‡‰ä»˜';
                const emoji = p.finalSettlement >= 0 ? 'ğŸŸ¢' : 'ğŸ”´';
                copyText += `${emoji} ${p.name}: ${action} ${amount} å…ƒ\n`;
            });

            copyText += '\n--- è½‰å¸³å»ºè­° (æœ€å°‘æ¬¡æ•¸) ---\n';

            // å¯¦æ–½è½‰å¸³æœ€å°åŒ–é‚è¼¯
            const settlementInstructions = [];
            let i = 0; // è¼¸å®¶ç´¢å¼•
            let j = 0; // è´å®¶ç´¢å¼•

            // è¤‡è£½çµæœæ•¸æ“šé€²è¡Œæ“ä½œï¼Œé¿å…ä¿®æ”¹åŸä¾†çš„ results
            const debtors_copy = JSON.parse(JSON.stringify(debtors));
            const creditors_copy = JSON.parse(JSON.stringify(creditors));

            while (i < debtors_copy.length && j < creditors_copy.length) {
                let debtor = debtors_copy[i];
                let creditor = creditors_copy[j];
                
                let debtAmount = Math.abs(debtor.finalSettlement);
                let creditAmount = creditor.finalSettlement;
                
                let transferAmount = Math.min(debtAmount, creditAmount);

                if (transferAmount > 0) {
                    settlementInstructions.push(`â¡ï¸ ${debtor.name} ä»˜æ¬¾çµ¦ ${creditor.name}: ${transferAmount.toFixed(0)} å…ƒ`);
                }
                
                // æ›´æ–°é¤˜é¡
                debtor.finalSettlement += transferAmount; 
                creditor.finalSettlement -= transferAmount; 

                // æª¢æŸ¥æ˜¯å¦çµæ¸… (ä½¿ç”¨å°æ–¼ 1 çš„é–¾å€¼é€²è¡Œæ•´æ•¸æ¯”è¼ƒï¼Œé¿å…æµ®é»èª¤å·®)
                if (Math.abs(debtor.finalSettlement) < 1) {
                    i++; 
                }
                if (creditor.finalSettlement < 1) {
                    j++; 
                }
            }
            
            if (settlementInstructions.length > 0) {
                 copyText += settlementInstructions.join('\n');
            } else {
                 copyText += 'âœ… å¸³å‹™å·²å¹³ï¼Œç„¡éœ€è½‰å¸³ï¼';
            }


            copyText += `\n\n--- çµç®—å®Œæˆï¼Œæ„Ÿè¬ä½¿ç”¨ï¼ ---`;

            document.getElementById('copyTextOutput').value = copyText.trim();
        }
        
        function copyToClipboard() {
            const copyText = document.getElementById("copyTextOutput");
            copyText.select();
            copyText.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                // ä½¿ç”¨è‡ªå®šç¾©è¨Šæ¯æ¡†æ›¿ä»£ alert()
                showNotification("å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼", 'success');
            } catch (err) {
                console.error("Copy failed:", err);
                showNotification("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚", 'error');
            }
        }
        
        // æ›¿ä»£ alert() çš„è‡ªå®šç¾©è¨Šæ¯æ¡†
        function showNotification(message, type) {
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                // åˆå§‹æ¨£å¼
                notification.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white transition-all duration-300 z-50 transform translate-x-full opacity-0';
                document.body.appendChild(notification);
            }
            
            notification.textContent = message;
            // æ›´æ–°æ¨£å¼å’Œä½ç½®
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white transition-all duration-300 z-50 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'} transform translate-x-0 opacity-100`;

            // è¨­ç½®å®šæ™‚å™¨ä½¿å…¶æ¶ˆå¤±
            setTimeout(() => {
                notification.className = notification.className.replace('translate-x-0 opacity-100', 'translate-x-full opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>
